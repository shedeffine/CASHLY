<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Financial Health Check</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background-color: #f4f7f9; color: #333; }
        .container { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
        h1, h2 { text-align: center; color: #0056b3; }
        .section-header { margin-top: 30px; font-weight: 600; font-size: 1.25em; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input[type="text"], input[type="number"] { width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        button { padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease; font-size: 1em; }
        button:hover { background-color: #0056b3; }
        #results { margin-top: 30px; padding: 20px; border-radius: 8px; background-color: #e9ecef; border: 1px solid #dee2e6; display: none; }
        .calculation-item, .feedback-item { margin-bottom: 10px; }
        .feedback-list { list-style-type: none; padding: 0; }
        .feedback-list li { background-color: #d1e7dd; padding: 12px; margin-bottom: 8px; border-radius: 8px; border-left: 5px solid #0056b3; }
        .loan-item { border: 1px solid #dee2e6; padding: 15px; margin-top: 15px; border-radius: 8px; background-color: #f8f9fa; }
        .remove-loan-btn { background: #dc3545; font-size: 0.8em; padding: 5px 10px; margin-left: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Financial Health Analysis</h1>
        <form id="financialForm">
            <label for="userId">User ID:</label>
            <input type="text" id="userId" name="userId" value="web_user" required>

            <div class="section-header">Income</div>
            <div id="income-inputs">
                <div class="input-group">
                    <label>Salary: <input type="number" name="income_salary" value="0"></label>
                </div>
            </div>

            <div class="section-header">Expenditure</div>
            <div id="expenditure-inputs">
                <div class="input-group">
                    <label>Rent: <input type="number" name="expenditure_rent" value="0"></label>
                </div>
            </div>

            <div class="section-header">Savings</div>
            <div id="savings-inputs">
                <div class="input-group">
                    <label>Emergency Fund: <input type="number" name="savings_emergency_fund" value="0"></label>
                </div>
            </div>

            <div class="section-header">Loans</div>
            <div id="loans-container">
                </div>
            <button type="button" id="add-loan-btn">Add Loan</button>

            <div style="text-align: center; margin-top: 30px;">
                <button type="submit">Analyze Financials</button>
            </div>
        </form>

        <div id="results">
            <h2>Analysis Results</h2>
            <div id="calculations-output"></div>
            <div id="feedback-output"></div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('financialForm');
            const addLoanBtn = document.getElementById('add-loan-btn');
            const loansContainer = document.getElementById('loans-container');
            const resultsDiv = document.getElementById('results');
            const calculationsOutput = document.getElementById('calculations-output');
            const feedbackOutput = document.getElementById('feedback-output');

            // Initial loan field
            addLoanBtn.click();

            // Function to add a new loan input block
            addLoanBtn.addEventListener('click', () => {
                const loanCount = loansContainer.children.length;
                const loanDiv = document.createElement('div');
                loanDiv.classList.add('loan-item');
                loanDiv.innerHTML = `
                    <p><strong>Loan #${loanCount + 1}</strong> <button type="button" class="remove-loan-btn">Remove</button></p>
                    <div class="input-group">
                        <label>Name: <input type="text" name="loan_name_${loanCount}" required></label>
                    </div>
                    <div class="input-group">
                        <label>Monthly Payment: <input type="number" name="loan_monthly_payment_${loanCount}" value="0" required></label>
                    </div>
                    <div class="input-group">
                        <label>Remaining Balance: <input type="number" name="loan_remaining_balance_${loanCount}" value="0" required></label>
                    </div>
                    <div class="input-group">
                        <label>Interest Rate: <input type="number" step="0.1" name="loan_interest_rate_${loanCount}" value="0" required></label>
                    </div>
                `;
                loansContainer.appendChild(loanDiv);
            });

            // Handle removing a loan
            loansContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-loan-btn')) {
                    e.target.closest('.loan-item').remove();
                }
            });

            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                // 1. Collect form data and build JSON payload
                const formData = new FormData(form);
                const financialData = {
                    income: {},
                    expenditure: {},
                    savings: {},
                    loans: []
                };

                // Populate income, expenditure, and savings
                for (const [key, value] of formData.entries()) {
                    if (key.startsWith('income_')) {
                        financialData.income[key.substring(7)] = parseFloat(value);
                    } else if (key.startsWith('expenditure_')) {
                        financialData.expenditure[key.substring(12)] = parseFloat(value);
                    } else if (key.startsWith('savings_')) {
                        financialData.savings[key.substring(8)] = parseFloat(value);
                    }
                }

                // Populate loans dynamically
                const loanItems = loansContainer.querySelectorAll('.loan-item');
                loanItems.forEach((loanItem, index) => {
                    const loan = {
                        name: loanItem.querySelector(`[name="loan_name_${index}"]`).value,
                        type: "debt", // Hardcoded as per the API's schema
                        monthly_payment: parseFloat(loanItem.querySelector(`[name="loan_monthly_payment_${index}"]`).value),
                        remaining_balance: parseFloat(loanItem.querySelector(`[name="loan_remaining_balance_${index}"]`).value),
                        interest_rate: parseFloat(loanItem.querySelector(`[name="loan_interest_rate_${index}"]`).value)
                    };
                    financialData.loans.push(loan);
                });

                const requestBody = {
                    user_id: formData.get('userId'),
                    financial_data: financialData
                };

                // 2. Send API request
                try {
                    const response = await fetch('http://localhost:8000/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        // Handle errors from the API
                        const errorMessage = data.detail ? data.detail.map(d => `${d.loc.join(' > ')}: ${d.msg}`).join('\n') : JSON.stringify(data);
                        alert(`API Error: ${response.status}\n\n${errorMessage}`);
                        return;
                    }

                    // 3. Display the results in a user-friendly way
                    let calculationsHtml = '';
                    for (const [key, value] of Object.entries(data.calculations)) {
                        calculationsHtml += `<div class="calculation-item"><strong>${key.replace(/_/g, ' ')}:</strong> ${value.toFixed(2)}</div>`;
                    }
                    calculationsOutput.innerHTML = calculationsHtml;

                    let feedbackHtml = '<ul class="feedback-list">';
                    data.feedback.forEach(item => {
                        feedbackHtml += `<li class="feedback-item">${item}</li>`;
                    });
                    feedbackHtml += '</ul>';
                    feedbackOutput.innerHTML = feedbackHtml;

                    resultsDiv.style.display = 'block';

                } catch (error) {
                    alert('An error occurred. Please check if the API server is running.');
                    console.error('Fetch error:', error);
                }
            });
        });
    </script>
</body>
</html>
